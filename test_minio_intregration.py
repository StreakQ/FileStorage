import os
import django
from pathlib import Path
import tempfile # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏

# 1. –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –≤–∞—à–µ–º—É settings.py (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —ç—Ç–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞)
BASE_DIR = Path(__file__).resolve().parent
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings') # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ 'config.settings' –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å

# 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Django
django.setup() # <- –≠—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞ –∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –î–û –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ settings

# --- –ò–ú–ü–û–†–¢ –ú–û–î–£–õ–ï–ô –ü–û–°–õ–ï django.setup() ---
# (–•–æ—Ç—è –∏–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è —Å–∞–º –ø–æ —Å–µ–±–µ –Ω–µ –¥–æ–ª–∂–µ–Ω –≤—ã–∑—ã–≤–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ settings –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞)
from files.services.fileStorage_service import FileStorageService
# --- –õ–û–ì–ò–ö–ê –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –í–ù–£–¢–†–ò –§–£–ù–ö–¶–ò–ò ---
def run_tests():
    print("--- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MinIO ---")
    try:
        # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
        # (–≠—Ç–æ –≤—ã–∑–æ–≤–µ—Ç _ensure_bucket_exists –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ)
        service = FileStorageService() # <-- –¢–µ–ø–µ—Ä—å —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ü–û–°–õ–ï django.setup()
        print("‚úÖ –°–µ—Ä–≤–∏—Å FileStorageService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –±–∞–∫–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω/—Å–æ–∑–¥–∞–Ω.")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–∞: {e}")
        return # –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º —Ç–µ—Å—Ç, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è

    # --- –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ ---
    print("\n--- –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ ---")
    user_id_to_test = 1 # –í–ê–ñ–ù–û: –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô ID –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø!
    filename_in_s3 = "test_folder/test_file_from_script.txt"

    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–∞
    with tempfile.NamedTemporaryFile(delete=False, suffix='.txt') as temp_file:
        temp_file.write(b"ASCII")
        temp_file_path = temp_file.name

    try:
        with open(temp_file_path, 'rb') as file_obj:
            success = service.upload_file(user_id_to_test, file_obj, filename_in_s3)
        if success:
            print(f"‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∫–∞–∫ {filename_in_s3} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id_to_test}")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id_to_test}")
    except Exception as e:
        print(f"‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: {e}")

    # --- –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ ---
    print("\n--- –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ ---")
    try:
        # –ü—Ä–æ–≤–µ—Ä–∏–º –∫–æ—Ä–µ–Ω—å –ø–∞–ø–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        items_root = service.list_files(user_id_to_test, prefix="")
        print(f"üìÅ –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ –∫–æ—Ä–Ω–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id_to_test}: {len(items_root)} —ç–ª–µ–º–µ–Ω—Ç–æ–≤")
        for item in items_root:
             print(f"   - {item['type']}: {item['name']}")

        # –ü—Ä–æ–≤–µ—Ä–∏–º –ø–æ–¥–ø–∞–ø–∫—É, –≥–¥–µ –º—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏ —Ñ–∞–π–ª
        items_in_test_folder = service.list_files(user_id_to_test, prefix="test_folder/")
        print(f"üìÅ –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ 'test_folder/' –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id_to_test}: {len(items_in_test_folder)} —ç–ª–µ–º–µ–Ω—Ç–æ–≤")
        for item in items_in_test_folder:
             print(f"   - {item['type']}: {item['name']}")

    except Exception as e:
        print(f"‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤: {e}")

    # --- –¢–µ—Å—Ç–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ ---
    print("\n--- –¢–µ—Å—Ç–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ ---")
    try:
        success_delete = service.delete_object(user_id_to_test, filename_in_s3)
        if success_delete:
            print(f"‚úÖ –§–∞–π–ª {filename_in_s3} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id_to_test}")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ {filename_in_s3} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id_to_test}")
    except Exception as e:
        print(f"‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: {e}")

    # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫–µ (–¥–ª—è —á–∏—Å—Ç–æ—Ç—ã)
    import os
    os.unlink(temp_file_path)
    print("\nüßπ –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫–µ —É–¥–∞–ª–µ–Ω.")

    print("\n--- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ ---")

# --- –í–ê–ñ–ù–û: –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –Ω–∞–ø—Ä—è–º—É—é ---
if __name__ == "__main__":
    run_tests() # <-- –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ü–û–°–õ–ï django.setup()
